{% extends "base.html" %}

{% block title %}Chat - Devstral AI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-chat-dots" aria-hidden="true"></i> Chat with AI
            </h1>
            <span class="text-muted">
                <i class="bi bi-person" aria-hidden="true"></i> {{ username }}
            </span>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Display existing messages -->
                {% if messages %}
                    {% for message in messages %}
                    <article class="message {{ 'user-message' if message.role == 'user' else 'assistant-message' }}" {% if loop.last %}id="latest"{% endif %}>
                        <div class="message-content">
                            {% if message.role == 'user' %}
                                <!-- User messages as plain text -->
                                <pre>{{ message.content }}</pre>
                            {% else %}
                                <!-- AI messages with markdown formatting -->
                                {% if message.content.startswith('<think>') %}
                                    {% set think_end = message.content.find('</think>') %}
                                    {% if think_end != -1 %}
                                        <details class="thinking-dropdown mb-3">
                                            <summary class="text-muted">ðŸ’­ Thinking process</summary>
                                            <div class="thinking-content mt-2 p-3 bg-dark rounded">
                                                {{ message.content[7:think_end] | markdown }}
                                            </div>
                                        </details>
                                        <div class="ai-response">
                                            {{ message.content[think_end+8:] | markdown }}
                                        </div>
                                    {% else %}
                                        <div class="ai-response">
                                            {{ message.content | markdown }}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="ai-response">
                                        {{ message.content | markdown }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% if message.timestamp %}
                        <small class="text-muted message-timestamp">
                            <time datetime="{{ message.timestamp }}">
                                {{ message.timestamp[:19].replace('T', ' ') }}
                            </time>
                        </small>
                        {% endif %}
                        {% if message.cached and message.role == 'assistant' %}
                        <div class="cached-indicator">
                            <i class="bi bi-lightning-fill" aria-hidden="true"></i> Cached response
                        </div>
                        {% endif %}
                    </article>
                    {% endfor %}
                {% else %}
                    <!-- Welcome message -->
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-dots" style="font-size: 3rem;" aria-hidden="true"></i>
                        <h2>Welcome to Devstral AI Chat</h2>
                        <p>Send a message to start chatting with the AI assistant</p>
                        <small class="text-muted">
                            <i class="bi bi-shield-check" aria-hidden="true"></i> Secure â€¢ 
                            <i class="bi bi-lightning" aria-hidden="true"></i> Fast â€¢ 
                            <i class="bi bi-cpu" aria-hidden="true"></i> AI-Powered
                        </small>
                    </div>
                {% endif %}
            </div>
            
            <!-- Message input form -->
            <div class="mt-3">
                <form method="POST" action="{{ url_for('chat.chat') }}" id="chatForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="input-group">
                        <label for="message" class="visually-hidden">Your message</label>
                        <textarea 
                            id="message"
                            name="message" 
                            class="form-control" 
                            placeholder="Type your message... Press Enter to send, Shift+Enter for new line" 
                            rows="3" 
                            maxlength="10000"
                            required 
                            autofocus
                            aria-describedby="message-help"
                        ></textarea>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-send" aria-hidden="true"></i> Send
                        </button>
                    </div>
                    <small id="message-help" class="text-muted">
                        <i class="bi bi-info-circle" aria-hidden="true"></i> 
                        Press Enter to send, Shift+Enter for new line
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script>
$(document).ready(function() {
    // Enter key submission
    $("#message").keydown(function (e) {     
        if(e.which === 13 && !e.shiftKey) {         
            e.preventDefault();              
            $(this).closest("form").submit();     
        } 
    });
    
    // Auto-scroll to latest message on page load
    if (window.location.hash === '#latest' || $('.message').length > 0) {
        const latestMessage = $('#latest');
        if (latestMessage.length > 0) {
            // Scroll so the latest message is at the top of the viewport
            $('html, body').animate({
                scrollTop: latestMessage.offset().top - 20
            }, 500);
        }
    }
});
</script>
{% endblock %}