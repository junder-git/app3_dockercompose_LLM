{% extends "base.html" %}

{% block title %}Chat - Devstral AI{% endblock %}

{% block content %}
<div class="row">
    <!-- Chat Sessions Sidebar -->
    <div class="col-md-3 d-none" id="sidebar">
        <div class="card border-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-chat-square"></i> Chats
                </h6>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" id="clear-chat-btn">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="chat-sessions">
                    {% for session in chat_sessions %}
                    <a href="/chat?session={{ session.id }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if session.id == current_session_id %}active{% endif %}">
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ session.title }}</div>
                            <small class="text-muted">{{ session.updated_at[:10] if session.updated_at else 'Unknown' }}</small>
                        </div>
                        {% if session.id != current_session_id %}
                        <button class="btn btn-sm btn-outline-danger delete-session-btn" 
                                data-session-id="{{ session.id }}" 
                                onclick="event.preventDefault(); deleteSession('{{ session.id }}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="col-12" id="main-chat">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary btn-sm me-3" id="toggle-sidebar">
                    <i class="bi bi-layout-sidebar"></i>
                </button>
                <h1>
                    <i class="bi bi-chat-dots" aria-hidden="true"></i> Chat with AI
                </h1>
            </div>
            <span class="text-muted">
                <i class="bi bi-person" aria-hidden="true"></i> {{ username }}
            </span>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Display existing messages in chronological order -->
                {% if messages %}
                    {% for message in messages %}
                    <article class="message {{ 'user-message' if message.role == 'user' else 'assistant-message' }}">
                        <div class="message-content">
                            {% if message.role == 'user' %}
                                <!-- User messages as plain text -->
                                <pre class="user-text">{{ message.content }}</pre>
                            {% else %}
                                <!-- AI messages WITH markdown formatting on page load -->
                                {% if message.content.startswith('<think>') %}
                                    {% set think_end = message.content.find('</think>') %}
                                    {% if think_end != -1 %}
                                        <details class="thinking-dropdown mb-3">
                                            <summary class="text-muted">üí≠ Thinking process</summary>
                                            <div class="thinking-content mt-2 p-3 bg-dark rounded">
                                                {{ message.content[7:think_end] | markdown }}
                                            </div>
                                        </details>
                                        <div class="ai-response">
                                            {{ message.content[think_end+8:] | markdown }}
                                        </div>
                                    {% else %}
                                        <div class="ai-response">
                                            {{ message.content | markdown }}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="ai-response">
                                        {{ message.content | markdown }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% if message.timestamp %}
                        <small class="text-muted message-timestamp">
                            <time datetime="{{ message.timestamp }}">
                                {{ message.timestamp[:19].replace('T', ' ') }}
                            </time>
                        </small>
                        {% endif %}
                        {% if message.cached and message.role == 'assistant' %}
                        <div class="cached-indicator">
                            <i class="bi bi-lightning-fill" aria-hidden="true"></i> Cached response
                        </div>
                        {% endif %}
                    </article>
                    {% endfor %}
                {% else %}
                    <!-- Welcome message -->
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-dots" style="font-size: 3rem;" aria-hidden="true"></i>
                        <h2>Welcome to Devstral AI Chat</h2>
                        <p>Send a message to start chatting with the AI assistant</p>
                        <small class="text-muted">
                            <i class="bi bi-shield-check" aria-hidden="true"></i> Secure ‚Ä¢ 
                            <i class="bi bi-lightning" aria-hidden="true"></i> Fast ‚Ä¢ 
                            <i class="bi bi-cpu" aria-hidden="true"></i> AI-Powered
                        </small>
                    </div>
                {% endif %}
                
                <!-- Streaming responses will be inserted here dynamically by JavaScript -->
                <!-- No static streaming response div - it will be created as needed -->
            </div>
            
            <!-- Message input form -->
            <div class="mt-3">
                <form method="POST" action="{{ url_for('chat.chat') }}" id="chatForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="input-group">
                        <label for="message" class="visually-hidden">Your message</label>
                        <textarea 
                            id="message"
                            name="message" 
                            class="form-control" 
                            placeholder="Type your message... Press Enter to send, Shift+Enter for new line" 
                            rows="3" 
                            maxlength="10000"
                            required 
                            autofocus
                            aria-describedby="message-help"
                        ></textarea>
                        <button class="btn btn-primary" type="submit" id="send-btn">
                            <i class="bi bi-send" aria-hidden="true"></i> Send
                        </button>
                    </div>
                    <small id="message-help" class="text-muted">
                        <i class="bi bi-info-circle" aria-hidden="true"></i> 
                        Press Enter to send, Shift+Enter for new line
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- REPLACE the script section in your chat/index.html with this -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
<script>
$(document).ready(function() {
    let eventSource = null;
    let streamId = null;
    let currentSessionId = '{{ current_session_id }}';
    let isStreaming = false;
    let streamedResponse = '';
    let currentUserMessage = '';
    let currentUserMessageElement = null;
    
    // DEBUGGING: Add extensive logging
    console.log('üöÄ Chat interface initialized');
    console.log('üìã Session ID:', currentSessionId);
    
    // Configure marked.js for better markdown support
    marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
            try {
                if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code;
            } catch (e) {
                console.warn('Highlight.js error:', e);
                return code;
            }
        }
    });
    
    // Get session ID from page if not provided
    if (!currentSessionId || currentSessionId === 'None') {
        currentSessionId = 'default_session';
        console.log('‚ö†Ô∏è Using default session ID');
    }
    
    // Sidebar toggle functionality
    $("#toggle-sidebar").on('click', function() {
        $("#sidebar").toggleClass('d-none');
        $("#main-chat").toggleClass('col-12 col-md-9');
        
        // Update button icon
        const icon = $(this).find('i');
        if ($("#sidebar").hasClass('d-none')) {
            icon.removeClass('bi-layout-sidebar').addClass('bi-layout-sidebar-reverse');
        } else {
            icon.removeClass('bi-layout-sidebar-reverse').addClass('bi-layout-sidebar');
        }
    });
    
    // Sidebar closed by default - set initial icon
    $("#toggle-sidebar").find('i').removeClass('bi-layout-sidebar').addClass('bi-layout-sidebar-reverse');
    
    // Enter key submission
    $("#message").keydown(function (e) {     
        if(e.which === 13 && !e.shiftKey && !isStreaming) {         
            e.preventDefault();              
            handleMessageSubmit();
        } 
    });
    
    // Form submission
    $("#chatForm").on('submit', function(e) {
        e.preventDefault(); // Always prevent default form submission
        console.log('üìù Form submitted');
        if (!isStreaming) {
            handleMessageSubmit();
        } else {
            console.log('‚ö†Ô∏è Already streaming, ignoring submit');
        }
    });
    
    // Clear chat button
    $("#clear-chat-btn").on('click', function() {
        if (confirm('Are you sure you want to clear all messages from this chat?')) {
            console.log('üßπ Clearing chat...');
            $.ajax({
                url: '/chat/clear',
                method: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
                },
                data: JSON.stringify({
                    session_id: currentSessionId
                }),
                success: function(response) {
                    console.log('‚úÖ Clear response:', response);
                    if (response.success) {
                        // Clear messages from UI immediately
                        $("#chat-messages").empty();
                        
                        // Add welcome message back
                        const welcomeHtml = `
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-dots" style="font-size: 3rem;" aria-hidden="true"></i>
                                <h2>Welcome to Devstral AI Chat</h2>
                                <p>Send a message to start chatting with the AI assistant</p>
                                <small class="text-muted">
                                    <i class="bi bi-shield-check" aria-hidden="true"></i> Secure ‚Ä¢ 
                                    <i class="bi bi-lightning" aria-hidden="true"></i> Fast ‚Ä¢ 
                                    <i class="bi bi-cpu" aria-hidden="true"></i> AI-Powered
                                </small>
                            </div>
                        `;
                        $("#chat-messages").html(welcomeHtml);
                        
                        // Focus on message input
                        $("#message").focus();
                    } else {
                        console.error('‚ùå Clear failed:', response.message);
                        alert('Error clearing chat: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Clear chat error:', error, xhr);
                    alert('Error clearing chat: ' + error);
                }
            });
        }
    });
    
    function handleMessageSubmit() {
        const message = $("#message").val().trim();
        console.log('üì§ Handling message submit:', message.substring(0, 50) + '...');
        
        if (!message) {
            console.log('‚ö†Ô∏è Empty message, ignoring');
            return;
        }
        
        if (isStreaming) {
            console.log('‚ö†Ô∏è Already streaming, ignoring');
            return;
        }
        
        currentUserMessage = message;
        
        // Add user message to chat immediately and store reference
        currentUserMessageElement = addUserMessage(message);
        
        // Clear input
        $("#message").val('');
        
        // Start streaming - this will add the AI response right after the user message
        startStreaming(message);
    }
    
    function addUserMessage(message) {
        console.log('üë§ Adding user message');
        const timestamp = new Date().toISOString();
        const messageHtml = `
            <article class="message user-message">
                <div class="message-content">
                    <pre class="user-text">${escapeHtml(message)}</pre>
                </div>
                <small class="text-muted message-timestamp">
                    <time datetime="${timestamp}">
                        ${new Date().toLocaleString()}
                    </time>
                </small>
            </article>
        `;
        
        // Remove any existing streaming response
        $("#streaming-response").remove();
        
        // Add user message to chat
        const messageElement = $(messageHtml);
        $("#chat-messages").append(messageElement);
        scrollToBottom();
        
        return messageElement;
    }
    
    function startStreaming(message) {
        if (isStreaming) {
            console.log('‚ö†Ô∏è Already streaming');
            return;
        }
        
        console.log('üéØ Starting stream for message:', message.substring(0, 50) + '...');
        
        isStreaming = true;
        streamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        streamedResponse = '';
        
        console.log('üÜî Stream ID:', streamId);
        console.log('üè∑Ô∏è Session ID:', currentSessionId);
        
        // Create streaming response element RIGHT AFTER the user message
        const streamingHtml = `
            <div id="streaming-response" class="message assistant-message">
                <div class="message-content">
                    <div class="ai-response" id="streaming-text">
                        <div class="text-muted">
                            <i class="bi bi-three-dots" style="animation: pulse 1.5s infinite;"></i> 
                            Connecting to AI...
                        </div>
                    </div>
                </div>
                <div class="streaming-controls mt-2">
                    <button id="interrupt-btn" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-stop-circle"></i> Stop Generation
                    </button>
                    <span class="text-muted ms-2">
                        <i class="bi bi-cpu"></i> Generating...
                    </span>
                </div>
            </div>
        `;
        
        // Insert streaming response right after the user message
        if (currentUserMessageElement) {
            currentUserMessageElement.after(streamingHtml);
        } else {
            $("#chat-messages").append(streamingHtml);
        }
        
        console.log('‚úÖ Added streaming response element');
        
        // Re-bind interrupt button since it was recreated
        $("#interrupt-btn").off('click').on('click', function() {
            console.log('üõë Interrupt button clicked');
            interruptStream();
        });
        
        // Disable form
        $("#send-btn").prop('disabled', true);
        $("#message").prop('disabled', true);
        
        // Create EventSource URL
        const params = new URLSearchParams({
            message: message,
            session_id: currentSessionId,
            stream_id: streamId
        });
        
        const streamUrl = `/chat/stream?${params}`;
        console.log('üîó Stream URL:', streamUrl);
        
        // Test if we can even make the request
        $.ajax({
            url: '/chat/stream',
            method: 'HEAD',
            timeout: 5000,
            success: function() {
                console.log('‚úÖ Stream endpoint is reachable');
                startEventSource(streamUrl);
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Stream endpoint test failed:', error, xhr.status);
                handleStreamError(`Stream endpoint unreachable: ${error} (${xhr.status})`);
            }
        });
    }
    
    function startEventSource(streamUrl) {
        console.log('üåä Creating EventSource...');
        
        try {
            eventSource = new EventSource(streamUrl);
            console.log('‚úÖ EventSource created successfully');
            
            // Add connection timeout
            const connectionTimeout = setTimeout(() => {
                console.error('‚è∞ EventSource connection timeout');
                if (eventSource) {
                    eventSource.close();
                }
                handleStreamError('Connection timeout - please try again');
            }, 30000); // 30 second timeout
            
            eventSource.onopen = function(event) {
                console.log('üîå EventSource connection opened:', event);
                clearTimeout(connectionTimeout);
                $("#streaming-text").html(`
                    <div class="text-muted">
                        <i class="bi bi-arrow-down-circle" style="animation: pulse 1.5s infinite;"></i> 
                        Connected! Waiting for response...
                    </div>
                `);
            };
            
            eventSource.onmessage = function(event) {
                console.log('üì® Received message:', event.data.substring(0, 100) + '...');
                clearTimeout(connectionTimeout);
                
                try {
                    const data = JSON.parse(event.data);
                    console.log('üìã Parsed data:', data);
                    
                    if (data.error) {
                        console.error('‚ùå Server error:', data.error);
                        handleStreamError(data.error);
                    } else if (data.interrupted) {
                        console.log('üõë Stream interrupted');
                        handleStreamInterrupted();
                    } else if (data.done) {
                        console.log('‚úÖ Stream completed');
                        handleStreamComplete();
                    } else if (data.content) {
                        streamedResponse += data.content;
                        console.log('üìù Content received, total length:', streamedResponse.length);
                        updateStreamingText(streamedResponse);
                        
                        if (data.cached) {
                            console.log('üíæ Using cached response');
                            $("#streaming-response .streaming-controls").prepend(
                                '<span class="badge bg-success me-2"><i class="bi bi-lightning-fill"></i> Cached</span>'
                            );
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Unexpected data format:', data);
                    }
                } catch (e) {
                    console.error('‚ùå Error parsing stream data:', e, 'Raw data:', event.data);
                    handleStreamError('Error parsing response data');
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('‚ùå EventSource error:', event);
                clearTimeout(connectionTimeout);
                
                // Check the readyState to understand what happened
                if (eventSource.readyState === EventSource.CONNECTING) {
                    console.log('üîÑ EventSource reconnecting...');
                    // Don't handle as error yet, it might reconnect
                } else if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('üîå EventSource connection closed');
                    handleStreamError('Connection lost');
                } else {
                    console.log('‚ö†Ô∏è EventSource unknown error state:', eventSource.readyState);
                    handleStreamError('Connection error');
                }
            };
            
        } catch (e) {
            console.error('‚ùå Failed to create EventSource:', e);
            handleStreamError('Failed to create connection: ' + e.message);
        }
        
        scrollToBottom();
    }
    
    // Use markdown formatting for streaming
    function updateStreamingText(text) {
        console.log('üé® Updating streaming text, length:', text.length);
        
        // Process thinking tags
        const thinkingPattern = /<think>([\s\S]*?)<\/think>/g;
        let processedText = text;
        let thinkingContent = '';
        
        // Extract thinking content
        let match;
        while ((match = thinkingPattern.exec(text)) !== null) {
            thinkingContent += match[1];
        }
        
        // Remove thinking tags from display text
        processedText = text.replace(thinkingPattern, '');
        
        try {
            // Convert markdown to HTML
            const html = marked.parse(processedText);
            
            // Update display
            let displayHtml = html;
            if (thinkingContent) {
                displayHtml = `
                    <details class="thinking-dropdown mb-3">
                        <summary class="text-muted">üí≠ Thinking process</summary>
                        <div class="thinking-content mt-2 p-3 bg-dark rounded">
                            ${marked.parse(thinkingContent)}
                        </div>
                    </details>
                    <div class="ai-response">
                        ${html}
                    </div>
                `;
            } else {
                displayHtml = `<div class="ai-response">${html}</div>`;
            }
            
            $("#streaming-text").html(displayHtml);
            scrollToBottom();
        } catch (e) {
            console.error('‚ùå Error formatting markdown:', e);
            // Fallback to plain text
            $("#streaming-text").html(`<div class="ai-response"><pre>${escapeHtml(processedText)}</pre></div>`);
            scrollToBottom();
        }
    }
    
    function handleStreamComplete() {
        console.log('üéâ Stream completed successfully');
        finishStreaming();
        convertStreamingToPermanent();
    }
    
    function handleStreamError(error) {
        console.error('‚ùå Stream error:', error);
        finishStreaming();
        $("#streaming-text").html(`
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>Error:</strong> ${error}
                <br><small>Please try again or contact support if the problem persists.</small>
            </div>
        `);
        
        // Auto-remove error after 10 seconds
        setTimeout(() => {
            $("#streaming-response").fadeOut(500, function() {
                $(this).remove();
            });
        }, 10000);
    }
    
    function handleStreamInterrupted() {
        console.log('üõë Stream was interrupted');
        finishStreaming();
        $("#streaming-text").append('<div class="text-muted mt-2"><i class="bi bi-stop-circle"></i> Generation interrupted</div>');
        
        if (streamedResponse.trim()) {
            convertStreamingToPermanent();
        } else {
            setTimeout(() => {
                $("#streaming-response").fadeOut(500, function() {
                    $(this).remove();
                });
            }, 2000);
        }
    }
    
    function finishStreaming() {
        console.log('üèÅ Finishing stream');
        
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            console.log('üîå EventSource closed');
        }
        
        isStreaming = false;
        
        // Re-enable form
        $("#send-btn").prop('disabled', false);
        $("#message").prop('disabled', false);
        $("#message").focus();
        
        console.log('üîì Form re-enabled');
    }
    
    function convertStreamingToPermanent() {
        console.log('üíæ Converting streaming to permanent');
        const html = $("#streaming-text").html();
        const timestamp = new Date().toISOString();
        
        // Create permanent message HTML
        const permanentHtml = `
            <div class="message-content">
                ${html}
            </div>
            <small class="text-muted message-timestamp">
                <time datetime="${timestamp}">
                    ${new Date().toLocaleString()}
                </time>
            </small>
        `;
        
        // Replace the streaming response content with permanent content
        $("#streaming-response").removeClass('streaming-response').html(permanentHtml);
        $("#streaming-response").removeAttr('id');
        
        scrollToBottom();
        console.log('‚úÖ Converted to permanent message');
    }
    
    function interruptStream() {
        if (!isStreaming || !streamId) {
            console.log('‚ö†Ô∏è No active stream to interrupt');
            return;
        }
        
        console.log('üõë Interrupting stream:', streamId);
        
        $.ajax({
            url: '/chat/interrupt',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            data: JSON.stringify({
                stream_id: streamId
            }),
            success: function(response) {
                console.log('‚úÖ Interrupt response:', response);
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Interrupt error:', error);
            }
        });
    }
    
    function scrollToBottom() {
        const chatMessages = $("#chat-messages")[0];
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Auto-scroll to bottom on page load
    if ($('.message').length > 0) {
        console.log('üìú Auto-scrolling to bottom');
        scrollToBottom();
    }
    
    // Window resize handler for responsive sidebar
    $(window).resize(function() {
        if (!$("#sidebar").hasClass('d-none')) {
            if (window.innerWidth <= 768) {
                $("#main-chat").removeClass('col-md-9').addClass('col-12');
            } else {
                $("#main-chat").removeClass('col-12').addClass('col-md-9');
            }
        }
    });
    
    // Add window error handler for debugging
    window.addEventListener('error', function(e) {
        console.error('üö® JavaScript error:', e.error, e.message, e.filename, e.lineno);
    });
    
    // Add unhandled promise rejection handler
    window.addEventListener('unhandledrejection', function(e) {
        console.error('üö® Unhandled promise rejection:', e.reason);
    });
    
    console.log('‚úÖ Chat interface setup complete');
});

// Delete session function
function deleteSession(sessionId) {
    console.log('üóëÔ∏è Deleting session:', sessionId);
    
    if (confirm('Are you sure you want to delete this chat session?')) {
        $.ajax({
            url: '/chat/delete_session',
            method: 'POST',
            contentType: 'application/json',
            headers: {
                'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
            },
            data: JSON.stringify({
                session_id: sessionId
            }),
            success: function(response) {
                console.log('‚úÖ Delete response:', response);
                if (response.success) {
                    window.location.href = '/chat';
                } else {
                    alert('Error deleting session: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('‚ùå Delete session error:', error, xhr);
                alert('Error deleting session: ' + error);
            }
        });
    }
}
</script>