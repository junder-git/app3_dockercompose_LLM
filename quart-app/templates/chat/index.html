{% extends "base.html" %}

{% block title %}Chat - Devstral AI{% endblock %}

{% block content %}
<div class="row">
    <!-- Chat Sessions Sidebar -->
    <div class="col-md-3" id="sidebar">
        <div class="card border-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-chat-square"></i> Chat Sessions
                </h6>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" id="new-chat-btn">
                        <i class="bi bi-plus"></i> New
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="clear-chat-btn">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="chat-sessions">
                    {% for session in chat_sessions %}
                    <a href="/chat?session={{ session.id }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if session.id == current_session_id %}active{% endif %}">
                        <div class="flex-grow-1">
                            <div class="fw-bold">{{ session.title }}</div>
                            <small class="text-muted">{{ session.updated_at[:10] if session.updated_at else 'Unknown' }}</small>
                        </div>
                        {% if session.id != current_session_id %}
                        <button class="btn btn-sm btn-outline-danger delete-session-btn" 
                                data-session-id="{{ session.id }}" 
                                onclick="event.preventDefault(); deleteSession('{{ session.id }}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="col-md-9" id="main-chat">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-secondary btn-sm me-3" id="toggle-sidebar">
                    <i class="bi bi-layout-sidebar"></i>
                </button>
                <h1>
                    <i class="bi bi-chat-dots" aria-hidden="true"></i> Chat with AI
                </h1>
            </div>
            <span class="text-muted">
                <i class="bi bi-person" aria-hidden="true"></i> {{ username }}
            </span>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <!-- Display existing messages in chronological order -->
                {% if messages %}
                    {% for message in messages %}
                    <article class="message {{ 'user-message' if message.role == 'user' else 'assistant-message' }}" {% if loop.last %}id="latest"{% endif %}>
                        <div class="message-content">
                            {% if message.role == 'user' %}
                                <!-- User messages as plain text -->
                                <pre class="user-text">{{ message.content }}</pre>
                            {% else %}
                                <!-- AI messages with markdown formatting -->
                                {% if message.content.startswith('<think>') %}
                                    {% set think_end = message.content.find('</think>') %}
                                    {% if think_end != -1 %}
                                        <details class="thinking-dropdown mb-3">
                                            <summary class="text-muted">ðŸ’­ Thinking process</summary>
                                            <div class="thinking-content mt-2 p-3 bg-dark rounded">
                                                {{ message.content[7:think_end] | markdown }}
                                            </div>
                                        </details>
                                        <div class="ai-response">
                                            {{ message.content[think_end+8:] | markdown }}
                                        </div>
                                    {% else %}
                                        <div class="ai-response">
                                            {{ message.content | markdown }}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="ai-response">
                                        {{ message.content | markdown }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% if message.timestamp %}
                        <small class="text-muted message-timestamp">
                            <time datetime="{{ message.timestamp }}">
                                {{ message.timestamp[:19].replace('T', ' ') }}
                            </time>
                        </small>
                        {% endif %}
                        {% if message.cached and message.role == 'assistant' %}
                        <div class="cached-indicator">
                            <i class="bi bi-lightning-fill" aria-hidden="true"></i> Cached response
                        </div>
                        {% endif %}
                    </article>
                    {% endfor %}
                {% else %}
                    <!-- Welcome message -->
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-dots" style="font-size: 3rem;" aria-hidden="true"></i>
                        <h2>Welcome to Devstral AI Chat</h2>
                        <p>Send a message to start chatting with the AI assistant</p>
                        <small class="text-muted">
                            <i class="bi bi-shield-check" aria-hidden="true"></i> Secure â€¢ 
                            <i class="bi bi-lightning" aria-hidden="true"></i> Fast â€¢ 
                            <i class="bi bi-cpu" aria-hidden="true"></i> AI-Powered
                        </small>
                    </div>
                {% endif %}
                
                <!-- Streaming response area -->
                <div id="streaming-response" class="message assistant-message" style="display: none;">
                    <div class="message-content">
                        <div class="ai-response" id="streaming-text"></div>
                    </div>
                    <div class="streaming-controls mt-2">
                        <button id="interrupt-btn" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-stop-circle"></i> Stop Generation
                        </button>
                        <span class="text-muted ms-2">
                            <i class="bi bi-cpu"></i> Generating...
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Message input form -->
            <div class="mt-3">
                <form method="POST" action="{{ url_for('chat.chat') }}" id="chatForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="input-group">
                        <label for="message" class="visually-hidden">Your message</label>
                        <textarea 
                            id="message"
                            name="message" 
                            class="form-control" 
                            placeholder="Type your message... Press Enter to send, Shift+Enter for new line" 
                            rows="3" 
                            maxlength="10000"
                            required 
                            autofocus
                            aria-describedby="message-help"
                        ></textarea>
                        <button class="btn btn-primary" type="submit" id="send-btn">
                            <i class="bi bi-send" aria-hidden="true"></i> Send
                        </button>
                    </div>
                    <small id="message-help" class="text-muted">
                        <i class="bi bi-info-circle" aria-hidden="true"></i> 
                        Press Enter to send, Shift+Enter for new line
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
<script>
$(document).ready(function() {
    let eventSource = null;
    let streamId = null;
    let currentSessionId = '{{ current_session_id }}';
    let isStreaming = false;
    let streamedResponse = '';
    let currentUserMessage = '';
    let refreshNeeded = false;
    
    // Configure marked.js for better markdown support
    marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return hljs.highlightAuto(code).value;
        }
    });
    
    // Get session ID from page if not provided
    if (!currentSessionId) {
        currentSessionId = 'default_session';
    }
    
    // Sidebar toggle functionality
    $("#toggle-sidebar").on('click', function() {
        $("#sidebar").toggleClass('d-none');
        $("#main-chat").toggleClass('col-md-9 col-12');
        
        // Update button icon
        const icon = $(this).find('i');
        if ($("#sidebar").hasClass('d-none')) {
            icon.removeClass('bi-layout-sidebar').addClass('bi-layout-sidebar-reverse');
        } else {
            icon.removeClass('bi-layout-sidebar-reverse').addClass('bi-layout-sidebar');
        }
    });
    
    // Auto-hide sidebar on mobile
    if (window.innerWidth <= 768) {
        $("#sidebar").addClass('d-none');
        $("#main-chat").removeClass('col-md-9').addClass('col-12');
        $("#toggle-sidebar").find('i').removeClass('bi-layout-sidebar').addClass('bi-layout-sidebar-reverse');
    }
    
    // Enter key submission
    $("#message").keydown(function (e) {     
        if(e.which === 13 && !e.shiftKey && !isStreaming) {         
            e.preventDefault();              
            handleMessageSubmit();
        } 
    });
    
    // Form submission
    $("#chatForm").on('submit', function(e) {
        e.preventDefault(); // Always prevent default form submission
        if (!isStreaming) {
            handleMessageSubmit();
        }
    });
    
    // Interrupt button
    $("#interrupt-btn").on('click', function() {
        interruptStream();
    });
    
    // New chat button
    $("#new-chat-btn").on('click', function() {
        $.ajax({
            url: '/chat/new',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(response) {
                if (response.success) {
                    window.location.href = '/chat?session=' + response.session_id;
                } else {
                    alert('Error creating new chat: ' + response.message);
                }
            },
            error: function() {
                alert('Error creating new chat');
            }
        });
    });
    
    // Clear chat button
    $("#clear-chat-btn").on('click', function() {
        if (confirm('Are you sure you want to clear all messages from this chat?')) {
            $.ajax({
                url: '/chat/clear',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    session_id: currentSessionId
                }),
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error clearing chat: ' + response.message);
                    }
                },
                error: function() {
                    alert('Error clearing chat');
                }
            });
        }
    });
    
    function handleMessageSubmit() {
        const message = $("#message").val().trim();
        if (!message) return;
        
        currentUserMessage = message;
        
        // Add user message to chat immediately
        addUserMessage(message);
        
        // Clear input
        $("#message").val('');
        
        // Start streaming
        startStreaming(message);
    }
    
    function addUserMessage(message) {
        const messageHtml = `
            <article class="message user-message">
                <div class="message-content">
                    <pre class="user-text">${escapeHtml(message)}</pre>
                </div>
                <small class="text-muted message-timestamp">
                    <time datetime="${new Date().toISOString()}">
                        ${new Date().toLocaleString()}
                    </time>
                </small>
            </article>
        `;
        $("#chat-messages").append(messageHtml);
        scrollToBottom();
    }
    
    function startStreaming(message) {
        if (isStreaming) return;
        
        isStreaming = true;
        streamId = 'stream_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        streamedResponse = '';
        refreshNeeded = false;
        
        // Show streaming response area
        $("#streaming-response").show();
        $("#streaming-text").html('');
        
        // Disable form
        $("#send-btn").prop('disabled', true);
        $("#message").prop('disabled', true);
        
        // Create EventSource
        const params = new URLSearchParams({
            message: message,
            session_id: currentSessionId,
            stream_id: streamId
        });
        
        eventSource = new EventSource(`/chat/stream?${params}`);
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    handleStreamError(data.error);
                } else if (data.interrupted) {
                    handleStreamInterrupted();
                } else if (data.done) {
                    handleStreamComplete();
                } else if (data.refresh_needed) {
                    refreshNeeded = true;
                } else if (data.content) {
                    streamedResponse += data.content;
                    updateStreamingText(streamedResponse);
                    if (data.cached) {
                        // Show cached indicator
                        $("#streaming-response .streaming-controls").prepend(
                            '<span class="badge bg-success me-2"><i class="bi bi-lightning-fill"></i> Cached</span>'
                        );
                    }
                }
            } catch (e) {
                console.error('Error parsing stream data:', e);
            }
        };
        
        eventSource.onerror = function(event) {
            console.error('EventSource error:', event);
            handleStreamError('Connection error');
        };
        
        scrollToBottom();
    }
    
    function updateStreamingText(text) {
        // Process thinking tags
        const thinkingPattern = /<think>([\s\S]*?)<\/think>/g;
        let processedText = text;
        let thinkingContent = '';
        
        // Extract thinking content
        let match;
        while ((match = thinkingPattern.exec(text)) !== null) {
            thinkingContent += match[1];
        }
        
        // Remove thinking tags from display text
        processedText = text.replace(thinkingPattern, '');
        
        // Convert markdown to HTML
        const html = marked.parse(processedText);
        
        // Update display
        let displayHtml = html;
        if (thinkingContent) {
            displayHtml = `
                <details class="thinking-dropdown mb-3">
                    <summary class="text-muted">ðŸ’­ Thinking process</summary>
                    <div class="thinking-content mt-2 p-3 bg-dark rounded">
                        ${marked.parse(thinkingContent)}
                    </div>
                </details>
                <div class="ai-response">
                    ${html}
                </div>
            `;
        } else {
            displayHtml = `<div class="ai-response">${html}</div>`;
        }
        
        $("#streaming-text").html(displayHtml);
        scrollToBottom();
    }
    
    function handleStreamComplete() {
        finishStreaming();
        
        // No need to save response - it's already saved in the stream
        // Convert to permanent message or refresh if needed
        if (refreshNeeded) {
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            convertStreamingToPermanent();
        }
    }
    
    function handleStreamError(error) {
        finishStreaming();
        $("#streaming-text").html(`<div class="alert alert-danger">Error: ${error}</div>`);
        setTimeout(() => {
            $("#streaming-response").hide();
        }, 3000);
    }
    
    function handleStreamInterrupted() {
        finishStreaming();
        $("#streaming-text").append('<div class="text-muted mt-2"><i class="bi bi-stop-circle"></i> Generation interrupted</div>');
        
        // Response is already saved in the stream, just refresh if needed
        if (refreshNeeded) {
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else if (streamedResponse.trim()) {
            convertStreamingToPermanent();
        } else {
            setTimeout(() => {
                $("#streaming-response").hide();
            }, 2000);
        }
    }
    
    function finishStreaming() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        
        isStreaming = false;
        
        // Re-enable form
        $("#send-btn").prop('disabled', false);
        $("#message").prop('disabled', false);
        $("#message").focus();
    }
    
    function convertStreamingToPermanent() {
        const html = $("#streaming-text").html();
        const messageHtml = `
            <article class="message assistant-message" id="latest">
                <div class="message-content">
                    ${html}
                </div>
                <small class="text-muted message-timestamp">
                    <time datetime="${new Date().toISOString()}">
                        ${new Date().toLocaleString()}
                    </time>
                </small>
            </article>
        `;
        
        $("#streaming-response").before(messageHtml);
        $("#streaming-response").hide();
        scrollToBottom();
    }
    
    function interruptStream() {
        if (!isStreaming || !streamId) return;
        
        $.ajax({
            url: '/chat/interrupt',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stream_id: streamId
            })
        });
    }
    
    function scrollToBottom() {
        $("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Auto-scroll to bottom on page load
    if ($('.message').length > 0) {
        scrollToBottom();
    }
    
    // Window resize handler for responsive sidebar
    $(window).resize(function() {
        if (window.innerWidth <= 768) {
            $("#sidebar").addClass('d-none');
            $("#main-chat").removeClass('col-md-9').addClass('col-12');
            $("#toggle-sidebar").find('i').removeClass('bi-layout-sidebar').addClass('bi-layout-sidebar-reverse');
        } else {
            $("#sidebar").removeClass('d-none');
            $("#main-chat").removeClass('col-12').addClass('col-md-9');
            $("#toggle-sidebar").find('i').removeClass('bi-layout-sidebar-reverse').addClass('bi-layout-sidebar');
        }
    });
});

// Delete session function
function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this chat session?')) {
        $.ajax({
            url: '/chat/delete_session',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                session_id: sessionId
            }),
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error deleting session: ' + response.message);
                }
            }
        });
    }
}
</script>

<!-- Include highlight.js for syntax highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>

{% endblock %}