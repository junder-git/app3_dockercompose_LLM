load_module modules/ngx_http_js_module.so;
load_module modules/ngx_http_redis2_module.so;

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Import NJS modules
    js_import auth from /etc/nginx/njs/auth.js;
    js_import database from /etc/nginx/njs/database.js;
    js_import utils from /etc/nginx/njs/utils.js;
    js_import admin from /etc/nginx/njs/admin.js;
    js_import models from /etc/nginx/njs/models.js;
    js_import chat from /etc/nginx/njs/chat.js;

    # Redis upstream
    upstream redis_backend {
        server redis:6379;
        keepalive 10;
    }

    server {
        listen 80;
        server_name localhost;

        root /usr/share/nginx/html;
        index index.html;

        # Internal Redis proxy for NJS modules
        location ~ ^/redis-internal/(.+) {
            internal;
            redis2_query $1;
            redis2_pass redis_backend;
        }

        # Authentication endpoint
        location = /auth {
            internal;
            js_content auth.verifyTokenEndpoint;
        }

        # API endpoints
        location /api/auth/login {
            js_content auth.handleLogin;
        }

        location /api/auth/register {
            js_content auth.handleRegister;
        }

        location /api/auth/verify {
            js_content auth.verifyTokenEndpoint;
        }

        location /health {
            js_content utils.healthCheck;
        }

        # Initialization endpoint - runs once at startup
        location /api/init {
            js_content utils.handleInit;
        }

        location ~ ^/api/admin/ {
            js_content admin.handleAdminRequest;
        }

        location ~ ^/api/chat/ {
            js_content chat.handleChatRequest;
        }

        location ~ ^/api/database/ {
            js_content database.handleDatabaseRequest;
        }

        # Static files
        location / {
            try_files $uri $uri/ =404;
        }

        # Error pages
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
        error_page 403 /unauthorised.html;
        error_page 429 /rate_limit.html;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
}