worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

env JWT_SECRET;
env REDIS_HOST;
env REDIS_PORT;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    resolver 127.0.0.11 ipv6=off;
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";

    server {
        listen 80;
        server_name localhost;

        # Static files
        location /js/ {
            root /usr/local/openresty/nginx/html;
        }
        location /css/ {
            root /usr/local/openresty/nginx/html;
        }
        location /assets/ {
            root /usr/local/openresty/nginx/html;
        }

        # API endpoints
        location = /api/auth/login {
            add_header 'Access-Control-Allow-Origin' '*';
            lua_need_request_body on;
            content_by_lua_block {
                ngx.req.read_body()
                local auth = require "auth"
                auth.handle_login()
            }
        }

        location = /api/register {
            add_header 'Access-Control-Allow-Origin' '*';
            lua_need_request_body on;
            content_by_lua_block {
                ngx.req.read_body()
                local register = require "register"
                register.handle_register()
            }
        }

        # Dynamic pages
        location = /chat.html {
            content_by_lua_block {
                local chat = require "chat"
                chat.handle_chat_page()
            }
        }

        location = /admin.html {
            content_by_lua_block {
                local admin = require "admin"
                admin.handle_admin_page()
            }
        }

        # Login & register pages (keep static)
        location = /login.html {
            try_files /login.html =404;
        }

        location = /register.html {
            try_files /register.html =404;
        }

        # Static index
        location = / {
            try_files /index.html =404;
        }

        # Errors
        error_page 404 /index.html;
        error_page 500 502 503 504 /index.html;
    }
}
