<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guest Chat - ai.junder.uk</title>
  <meta name="chat-storage" content="localStorage">
  <meta name="user-type" content="guest">
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/common.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .guest-badge { 
      background: linear-gradient(135deg, #6c757d, #adb5bd); 
      color: white; 
      padding: 0.25rem 0.5rem; 
      border-radius: 12px; 
      font-size: 0.75rem; 
      margin-left: 0.5rem; 
    }
    .model-selector { 
      position: absolute; 
      top: 10px; 
      right: 10px; 
      background: rgba(108, 117, 125, 0.1); 
      border: 1px solid rgba(108, 117, 125, 0.3); 
      border-radius: 8px; 
      padding: 0.5rem; 
      font-size: 0.8rem; 
      color: #6c757d; 
    }
    .guest-limits {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .countdown-timer {
      position: fixed;
      top: 70px;
      left: 20px;
      background: #ffc107;
      color: #000;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      z-index: 1000;
      font-weight: bold;
    }
    .guest-warning {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  {{ nav }}

  <div class="countdown-timer" id="countdown-timer" style="display: none;">
    <i class="bi bi-clock"></i> <span id="timer-text">-- min left</span>
  </div>

  <main class="chat-container">
    <div class="model-selector">
      <i class="bi bi-cpu"></i> <strong>{{ model_name }}</strong>
      <span class="guest-badge">GUEST</span>
    </div>

    <div class="guest-warning">
      <i class="bi bi-info-circle text-warning"></i>
      <strong>Guest Session:</strong> Chat history stored locally in your browser only. 
      <a href="/register.html" class="text-warning"><u>Register for full access</u></a>
    </div>

    <div class="guest-limits">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-0"><i class="bi bi-clock-history text-warning"></i> Guest Session Limits</h6>
          <small class="text-muted">
            Messages: <span id="message-count">{{ used_messages }}</span>/<span id="message-limit">{{ max_messages }}</span> • 
            Time: <span id="session-remaining">{{ session_remaining }}</span> min left
          </small>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-warning btn-sm" onclick="downloadGuestHistory()">
            <i class="bi bi-download"></i> Download
          </button>
          <a href="/register.html" class="btn btn-warning btn-sm">
            <i class="bi bi-person-plus"></i> Register
          </a>
        </div>
      </div>
      <div class="progress mt-2" style="height: 4px;">
        <div class="progress-bar bg-warning" id="message-progress" style="width: {{ message_progress }}%"></div>
      </div>
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="welcome-prompt" id="welcome-prompt">
        <h4><i class="bi bi-person-badge text-warning"></i> Guest Chat Session</h4>
        <p>Hello <strong>{{ username }}</strong>! You're using a limited guest session.</p>
        <p><strong>Limitations:</strong> {{ max_messages }} messages max • {{ session_duration }} min session • localStorage only</p>
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>Note:</strong> Your chat history is only stored in your browser. Clear browser data = lost chats.
        </div>
        <div class="suggestion-chips">
          <div class="suggestion-chip" data-prompt="Help me with a quick coding question:">Quick Code Help</div>
          <div class="suggestion-chip" data-prompt="Explain this concept briefly:">Explain Concept</div>
          <div class="suggestion-chip" data-prompt="Debug this simple code:">Debug Code</div>
          <div class="suggestion-chip" data-prompt="What's the best practice for:">Best Practice</div>
        </div>
        <div class="text-center mt-3">
          <a href="/register.html" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> Register for Unlimited Access
          </a>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <form id="chat-form" class="chat-input-form">
        <textarea 
          class="form-control chat-input" 
          id="chat-input" 
          placeholder="Guest mode: Ask a quick question (limited messages)..." 
          required
          maxlength="2000"
          {{ disabled }}></textarea>
        <div class="chat-tools">
          <button type="submit" class="btn btn-warning btn-icon" id="send-button" {{ disabled }}>
            <i class="bi bi-send"></i>
          </button>
          <button type="button" class="btn btn-danger btn-icon stop-button" id="stop-button" style="display: none;">
            <i class="bi bi-stop-fill"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary btn-icon" id="clear-chat">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </form>
      <div class="form-text text-center mt-2">
        <small class="text-muted">
          <span id="char-count">0</span>/2000 characters • Guest Session • localStorage Storage
        </small>
      </div>
    </div>
  </main>

  <script src="/js/lib/jquery.min.js"></script>
  <script src="/js/lib/bootstrap.min.js"></script>
  <script src="/js/common.js"></script>
  <script>
    class GuestChat {
      constructor() {
        this.username = '{{ username }}';
        this.isTyping = false;
        this.abortController = null;
        this.messageCount = parseInt('{{ used_messages }}') || 0;
        this.maxMessages = parseInt('{{ max_messages }}') || 10;
        this.sessionRemaining = parseInt('{{ session_remaining }}') || 1800;
        this.disabled = '{{ disabled }}' === 'disabled';
        this.init();
      }

      init() {
        if (this.disabled) {
          this.showSessionFull();
          return;
        }

        this.setupEventListeners();
        this.loadChatHistory();
        this.setupSuggestionChips();
        this.startCountdown();
        this.updateLimitsDisplay();
        console.log('👤 Guest chat initialized for:', this.username);
      }

      showSessionFull() {
        const chatContainer = document.querySelector('.chat-container');
        chatContainer.innerHTML = `
          <div class="alert alert-warning text-center m-4">
            <h4><i class="bi bi-people-fill"></i> Chat is Currently Full</h4>
            <p>All guest chat slots are occupied. Please try again in a few minutes or register for unlimited access.</p>
            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-warning" onclick="window.location.reload()">
                <i class="bi bi-arrow-clockwise"></i> Try Again
              </button>
              <a href="/register.html" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Register for Full Access
              </a>
            </div>
          </div>
        `;
      }

      setupEventListeners() {
        document.getElementById('chat-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.sendMessage();
        });

        document.getElementById('stop-button').addEventListener('click', () => this.stopGeneration());
        document.getElementById('clear-chat').addEventListener('click', () => this.clearChat());
        
        const textarea = document.getElementById('chat-input');
        textarea.addEventListener('input', (e) => this.updateCharCount());
        textarea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });
      }

      setupSuggestionChips() {
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            if (this.messageCount >= this.maxMessages) {
              alert('Message limit reached! Register for unlimited access.');
              return;
            }
            document.getElementById('chat-input').value = chip.dataset.prompt;
            document.getElementById('chat-input').focus();
            this.updateCharCount();
          });
        });
      }

      startCountdown() {
        const timer = document.getElementById('countdown-timer');
        const timerText = document.getElementById('timer-text');
        
        if (this.sessionRemaining > 0) {
          timer.style.display = 'block';
          
          this.countdownInterval = setInterval(() => {
            this.sessionRemaining--;
            
            if (this.sessionRemaining <= 0) {
              this.showSessionExpired();
              return;
            }
            
            const minutes = Math.floor(this.sessionRemaining / 60);
            const seconds = this.sessionRemaining % 60;
            timerText.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds + ' left';
            
            if (this.sessionRemaining < 300) { // 5 minutes
              timer.style.background = '#dc3545';
              timer.style.color = 'white';
            }
          }, 1000);
        }
      }

      showSessionExpired() {
        clearInterval(this.countdownInterval);
        const chatContainer = document.querySelector('.chat-container');
        chatContainer.innerHTML = `
          <div class="alert alert-danger text-center m-4">
            <h4><i class="bi bi-clock-history"></i> Session Expired</h4>
            <p>Your guest session has expired. Start a new session or register for unlimited access.</p>
            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-warning" onclick="window.location.reload()">
                <i class="bi bi-arrow-clockwise"></i> New Session
              </button>
              <a href="/register.html" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Register for Full Access
              </a>
            </div>
          </div>
        `;
      }

      updateLimitsDisplay() {
        document.getElementById('message-count').textContent = this.messageCount;
        document.getElementById('message-limit').textContent = this.maxMessages;
        
        const progress = (this.messageCount / this.maxMessages) * 100;
        document.getElementById('message-progress').style.width = progress + '%';
        
        if (this.messageCount >= this.maxMessages) {
          document.getElementById('send-button').disabled = true;
          document.getElementById('chat-input').disabled = true;
          document.getElementById('chat-input').placeholder = 'Message limit reached - register for unlimited access';
        }
      }

      updateCharCount() {
        const textarea = document.getElementById('chat-input');
        const count = textarea.value.length;
        document.getElementById('char-count').textContent = count;
      }

      loadChatHistory() {
        // Load from localStorage via GuestChatStorage
        if (typeof GuestChatStorage !== 'undefined') {
          const messages = GuestChatStorage.getMessages();
          if (messages.length > 0) {
            document.getElementById('welcome-prompt').style.display = 'none';
            messages.forEach(msg => {
              this.addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content, false);
            });
            console.log('📱 Loaded', messages.length, 'messages from localStorage');
          }
        }
      }

      async sendMessage() {
        if (this.messageCount >= this.maxMessages) {
          alert('Message limit reached! Register for unlimited access.');
          return;
        }

        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || this.isTyping) return;

        document.getElementById('welcome-prompt').style.display = 'none';
        this.addMessage('user', message);
        input.value = '';
        this.updateCharCount();
        
        this.messageCount++;
        this.updateLimitsDisplay();
        
        this.isTyping = true;
        this.updateButtons(true);

        this.abortController = new AbortController();
        const aiMessage = this.addMessage('ai', '', true);
        let accumulated = '';

        try {
          const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            signal: this.abortController.signal,
            body: JSON.stringify({ 
              message: message,
              options: {
                temperature: 0.8,
                max_tokens: 1024 // Guest gets fewer tokens
              }
            })
          });

          if (!response.ok) throw new Error('HTTP ' + response.status);

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const jsonStr = line.slice(6);
                if (jsonStr === '[DONE]') {
                  this.finishStreaming(aiMessage, accumulated);
                  return;
                }

                try {
                  const data = JSON.parse(jsonStr);
                  if (data.content) {
                    accumulated += data.content;
                    this.updateStreamingMessage(aiMessage, accumulated);
                  }
                } catch (e) {}
              }
            }
          }
        } catch (error) {
          if (error.name !== 'AbortError') {
            console.error('Guest chat error:', error);
            this.updateStreamingMessage(aiMessage, '*Error: ' + error.message + '*');
          }
          this.finishStreaming(aiMessage, accumulated);
        }
      }

      addMessage(sender, content, isStreaming = false) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${sender}`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (sender === 'user') {
          contentDiv.innerHTML = `<div class="d-flex align-items-center mb-1">
            <i class="bi bi-person-badge text-warning me-2"></i>
            <strong>${this.username} (Guest)</strong>
          </div>` + marked.parse(content);
          
          // Save to localStorage
          if (typeof GuestChatStorage !== 'undefined') {
            GuestChatStorage.saveMessage('user', content);
          }
        } else {
          contentDiv.innerHTML = isStreaming ? 
            '<span class="streaming-content"></span>' : 
            marked.parse(content);
        }
        
        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return messageDiv;
      }

      updateStreamingMessage(messageDiv, content) {
        const streamingEl = messageDiv.querySelector('.streaming-content');
        if (streamingEl) {
          streamingEl.innerHTML = marked.parse(content) + '<span class="cursor">▋</span>';
        }
      }

      finishStreaming(messageDiv, finalContent) {
        const streamingEl = messageDiv.querySelector('.streaming-content');
        if (streamingEl) {
          streamingEl.innerHTML = marked.parse(finalContent);
          
          // Save AI response to localStorage
          if (typeof GuestChatStorage !== 'undefined') {
            GuestChatStorage.saveMessage('assistant', finalContent);
          }
        }
        this.isTyping = false;
        this.updateButtons(false);
      }

      stopGeneration() {
        if (this.abortController) {
          this.abortController.abort();
        }
      }

      updateButtons(isTyping) {
        document.getElementById('send-button').style.display = isTyping ? 'none' : 'flex';
        document.getElementById('stop-button').style.display = isTyping ? 'flex' : 'none';
        document.getElementById('chat-input').disabled = isTyping || this.messageCount >= this.maxMessages;
      }

      clearChat() {
        if (!confirm('Clear guest chat history? This will only clear your browser storage.')) return;

        if (typeof GuestChatStorage !== 'undefined') {
          GuestChatStorage.clearMessages();
        }
        
        document.getElementById('chat-messages').innerHTML = '';
        document.getElementById('welcome-prompt').style.display = 'block';
        console.log('🗑️ Guest chat history cleared from localStorage');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.guestChat = new GuestChat();
    });
  </script>
</body>
</html>