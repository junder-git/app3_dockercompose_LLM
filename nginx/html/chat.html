<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat - ai.junder.uk</title>
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/common.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .chat-input-container { width: 100%; }
    .chat-input-form { display: flex; gap: 8px; flex-wrap: nowrap; width: 100%; }
    .chat-input { flex: 1; min-height: 100px; max-height: 250px; resize: none; }
    .btn-icon { min-width: 44px; height: 44px; }
    .message { 
      margin-bottom: 1rem; 
      animation: slideIn 0.3s ease-out; 
      display: flex; 
      align-items: flex-start; 
      gap: 0.75rem; 
    }
    .message-user { flex-direction: row-reverse; }
    .message-ai { flex-direction: row; }
    .message-content { 
      max-width: 70%; 
      padding: 12px 16px; 
      border-radius: 16px; 
      word-wrap: break-word; 
      position: relative;
    }
    .message-user .message-content { 
      background: linear-gradient(135deg, #0d6efd, #6610f2); 
      color: white; 
    }
    .message-ai .message-content { 
      background: var(--bg-tertiary); 
      border: 1px solid var(--border-color); 
      color: var(--text-primary); 
    }
    .streaming-content { position: relative; }
    .cursor { 
      animation: blink 1s infinite; 
      color: var(--primary-color); 
      font-weight: bold; 
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .chat-status { 
      position: fixed; 
      top: 70px; 
      right: 20px; 
      z-index: 1000; 
      padding: 0.5rem 1rem; 
      border-radius: 20px; 
      font-size: 0.85rem; 
      transition: all 0.3s ease; 
    }
    .status-online { background: rgba(40, 167, 69, 0.9); color: white; }
    .status-typing { background: rgba(13, 110, 253, 0.9); color: white; }
    .status-error { background: rgba(220, 53, 69, 0.9); color: white; }
    .model-selector { 
      position: absolute; 
      top: 10px; 
      right: 10px; 
      font-size: 0.8rem; 
      color: var(--text-muted); 
    }
    .welcome-prompt {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      margin: 2rem;
      background: var(--bg-tertiary);
    }
    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
      justify-content: center;
    }
    .suggestion-chip {
      background: var(--bg-quaternary);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .suggestion-chip:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    .chat-tools {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-left: auto;
    }
    .message-actions {
      position: absolute;
      top: -10px;
      right: 10px;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 0.25rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      border: 1px solid var(--border-color);
    }
    .message:hover .message-actions { opacity: 1; }
    .action-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 0.25rem;
      border-radius: 4px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .action-btn:hover { color: var(--primary-color); }
  </style>
</head>
<body>
  {{ navigation }}

  <div class="chat-status" id="chat-status" style="display: none;">
    <i class="bi bi-circle-fill me-1"></i>
    <span id="status-text">Ready</span>
  </div>

  <main class="chat-container">
    <div class="model-selector" id="model-info">
      <i class="bi bi-cpu"></i> <span id="current-model">Loading...</span>
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="welcome-prompt" id="welcome-prompt">
        <h4><i class="bi bi-robot"></i> Welcome to ai.junder.uk</h4>
        <div id="welcome-content">
          <!-- Content will be dynamically set based on user type -->
        </div>
        <div class="suggestion-chips" id="suggestion-chips" style="display: none;">
          <div class="suggestion-chip" data-prompt="Help me debug this Python code">Debug Python Code</div>
          <div class="suggestion-chip" data-prompt="Create a React component for">Build React Component</div>
          <div class="suggestion-chip" data-prompt="Explain this algorithm:">Explain Algorithm</div>
          <div class="suggestion-chip" data-prompt="Optimize this SQL query:">Optimize SQL</div>
          <div class="suggestion-chip" data-prompt="Review my code for best practices">Code Review</div>
        </div>
        <div id="session-info" class="mt-3" style="display: none;">
          <div class="alert alert-info">
            <i class="bi bi-clock"></i> Session expires in: <span id="session-countdown">--</span>
          </div>
        </div>
        <div id="chat-full-message" class="mt-3" style="display: none;">
          <div class="alert alert-warning">
            <h6><i class="bi bi-people-fill"></i> Chat is Currently Full</h6>
            <p id="capacity-message">All guest chat slots are occupied. Please try again in a few minutes or register for unlimited access.</p>
            <button class="btn btn-primary btn-sm" onclick="window.location.reload()">
              <i class="bi bi-arrow-clockwise"></i> Try Again
            </button>
            <a href="/register.html" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-person-plus"></i> Register for Full Access
            </a>
          </div>
        </div>
        <div id="guest-start-message" class="mt-3" style="display: none;">
          <div class="alert alert-primary">
            <h6><i class="bi bi-chat-dots"></i> Start Guest Chat Session</h6>
            <p>Try our AI assistant with a free guest session. No registration required!</p>
            <button class="btn btn-primary" id="start-guest-session">
              <i class="bi bi-play-circle"></i> Start Guest Chat
            </button>
            <a href="/register.html" class="btn btn-outline-primary btn-sm ms-2">
              <i class="bi bi-person-plus"></i> Register for Full Access
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <form id="chat-form" class="chat-input-form">
        <textarea 
          class="form-control chat-input" 
          id="chat-input" 
          placeholder="Ask me anything about coding, algorithms, or development..." 
          required
          maxlength="4000"></textarea>
        <div class="chat-tools">
          <button type="button" class="btn btn-outline-secondary btn-icon" id="attach-btn" title="Attach File" disabled>
            <i class="bi bi-paperclip"></i>
          </button>
          <button type="submit" class="btn btn-primary btn-icon" id="send-button">
            <i class="bi bi-send"></i>
          </button>
          <button type="button" class="btn btn-danger btn-icon stop-button" id="stop-button" style="display: none;" title="Stop Generation">
            <i class="bi bi-stop-fill"></i>
          </button>
          <button type="button" class="btn btn-outline-secondary btn-icon" id="clear-chat" title="Clear Chat">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </form>
      <div class="form-text text-center mt-2">
        <small class="text-muted">
          <span id="char-count">0</span>/4000 characters â€¢ 
          Press <kbd>Enter</kbd> to send, <kbd>Shift+Enter</kbd> for new line
        </small>
      </div>
    </div>
  </main>

  <script src="/js/lib/jquery.min.js"></script>
  <script src="/js/lib/bootstrap.min.js"></script>
  <script src="/js/common.js"></script>
  <script>
    class DevstralChat {
      constructor() {
        this.isTyping = false;
        this.abortController = null;
        this.messageCount = 0;
        this.lastActivity = Date.now();
        this.username = '{{ username }}'; // Server-side template variable
        this.autoSaveTimer = null;
        this.suggestions = [
          "Help me debug this Python code",
          "Create a React component for",
          "Explain this algorithm:",
          "Optimize this SQL query:",
          "Review my code for best practices",
          "Write a function that",
          "How do I implement",
          "What's the best practice for"
        ];
        this.init();
      }

      init() {
        // Parse template data
        this.isGuest = '{{ is_guest }}' === 'true';
        this.isPlaceholder = '{{ is_placeholder }}' === 'true';
        this.chatFull = '{{ chat_full }}' === 'true';
        this.guestLimits = this.parseGuestLimits();
        
        this.setupWelcomeMessage();
        this.setupEventListeners();
        
        if (!this.isPlaceholder && !this.chatFull) {
          this.loadChatHistory();
          if (this.isGuest) {
            this.setupSessionCountdown();
          }
        }
        
        this.updateStatus('online', 'Ready');
        this.setupKeyboardShortcuts();
        this.startActivityMonitoring();
        this.loadModelInfo();
        
        // Track page analytics
        DevstralCommon.trackEvent('page_view', 'chat');
        
        console.log('ðŸ¤– Chat initialized for user: ' + this.username);
      }

      parseGuestLimits() {
        try {
          const limitsStr = '{{ guest_limits }}';
          return limitsStr !== 'null' ? JSON.parse(limitsStr) : null;
        } catch (e) {
          return null;
        }
      }

      setupWelcomeMessage() {
        const welcomeContent = document.getElementById('welcome-content');
        const suggestionChips = document.getElementById('suggestion-chips');
        const sessionInfo = document.getElementById('session-info');
        const chatFullMessage = document.getElementById('chat-full-message');
        const guestStartMessage = document.getElementById('guest-start-message');

        if (this.chatFull) {
          // Show chat full message
          welcomeContent.innerHTML = '<p>Chat is currently at capacity. Please try again later or register for unlimited access.</p>';
          chatFullMessage.style.display = 'block';
          this.disableChatInput();
        } else if (this.isPlaceholder) {
          // Show placeholder message with guest session option
          welcomeContent.innerHTML = '<p>Hello! Welcome to ai.junder.uk. Start a free guest session to try our AI assistant.</p>';
          guestStartMessage.style.display = 'block';
          this.disableChatInput();
          
          // Set up guest session creation button
          const startButton = document.getElementById('start-guest-session');
          if (startButton) {
            startButton.addEventListener('click', () => this.createGuestSession());
          }
        } else if (this.isGuest) {
          // Show guest session info
          welcomeContent.innerHTML = '<p>Hello <strong>' + this.username + '</strong>! You have a limited demo session.</p>';
          suggestionChips.style.display = 'flex';
          sessionInfo.style.display = 'block';
        } else {
          // Show full user welcome
          welcomeContent.innerHTML = '<p>Hello <strong>' + this.username + '</strong>! I\'m your advanced coding assistant powered by Devstral AI.</p><p>What would you like to build today?</p>';
          suggestionChips.style.display = 'flex';
        }
      }

      async createGuestSession() {
        const startButton = document.getElementById('start-guest-session');
        const originalText = startButton.innerHTML;
        
        try {
          startButton.disabled = true;
          startButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating session...';
          
          const response = await fetch('/api/guest/create-session', {
            method: 'POST',
            credentials: 'include'
          });
          
          const data = await response.json();
          
          if (data.success) {
            this.showToast('Guest session created successfully!', 'success');
            
            // Update page state
            this.username = data.session.username;
            this.isGuest = true;
            this.isPlaceholder = false;
            this.guestLimits = data.limits;
            
            // Refresh the page to load with new session
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            throw new Error(data.message || 'Failed to create guest session');
          }
        } catch (error) {
          console.error('Create guest session error:', error);
          this.showToast('Failed to create guest session: ' + error.message, 'error');
          
          startButton.disabled = false;
          startButton.innerHTML = originalText;
        }
      }

      showToast(message, type, duration) {
        type = type || 'info';
        duration = duration || 3000;

        // Create toast element
        const toast = document.createElement('div');
        toast.className = 'position-fixed';
        toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
        
        toast.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        document.body.appendChild(toast);

        // Auto-remove after duration
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, duration);
      }

      setupSessionCountdown() {
        if (this.isGuest && this.guestLimits && this.guestLimits.session_remaining) {
          this.sessionCountdownInterval = setInterval(() => {
            this.updateSessionCountdown();
          }, 1000);
        }
      }

      updateSessionCountdown() {
        if (!this.guestLimits || !this.guestLimits.session_remaining) return;

        this.guestLimits.session_remaining--;
        const countdown = document.getElementById('session-countdown');
        
        if (this.guestLimits.session_remaining <= 0) {
          clearInterval(this.sessionCountdownInterval);
          countdown.textContent = 'Session Expired';
          this.showSessionExpiredMessage();
          return;
        }

        const minutes = Math.floor(this.guestLimits.session_remaining / 60);
        const seconds = this.guestLimits.session_remaining % 60;
        countdown.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        
        // Change color as time runs out
        if (this.guestLimits.session_remaining < 300) { // 5 minutes
          countdown.parentElement.className = 'alert alert-warning';
        }
        if (this.guestLimits.session_remaining < 60) { // 1 minute
          countdown.parentElement.className = 'alert alert-danger';
        }
      }

      showSessionExpiredMessage() {
        const welcomePrompt = document.getElementById('welcome-prompt');
        welcomePrompt.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-clock-history"></i> Session Expired</h5>
            <p>Your guest session has expired. Please refresh the page to start a new session or register for unlimited access.</p>
            <button class="btn btn-primary" onclick="window.location.reload()">
              <i class="bi bi-arrow-clockwise"></i> Start New Session
            </button>
            <a href="/register.html" class="btn btn-outline-primary ms-2">
              <i class="bi bi-person-plus"></i> Register for Full Access
            </a>
          </div>
        `;
        this.disableChatInput();
      }

      disableChatInput() {
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        
        chatInput.disabled = true;
        chatInput.placeholder = 'Chat unavailable - please refresh or register';
        sendButton.disabled = true;
      }

      setupEventListeners() {
        // Form submission
        document.getElementById('chat-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.sendMessage();
        });

        // Control buttons
        document.getElementById('stop-button').addEventListener('click', () => this.stopGeneration());
        document.getElementById('clear-chat').addEventListener('click', () => this.clearChat());
        
        // Textarea controls
        const textarea = document.getElementById('chat-input');
        textarea.addEventListener('keydown', (e) => this.handleKeyDown(e));
        textarea.addEventListener('input', (e) => this.handleInput(e));
        textarea.addEventListener('paste', (e) => this.handlePaste(e));

        // Suggestion chips
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const prompt = chip.dataset.prompt;
            document.getElementById('chat-input').value = prompt;
            document.getElementById('chat-input').focus();
            this.updateCharCount();
          });
        });

        // Window events
        window.addEventListener('beforeunload', () => this.handlePageUnload());
        window.addEventListener('focus', () => this.handleWindowFocus());
        window.addEventListener('blur', () => this.handleWindowBlur());
      }

      setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          // Ctrl/Cmd + K to focus input
          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('chat-input').focus();
          }
          
          // Ctrl/Cmd + Shift + C to clear chat
          if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
            e.preventDefault();
            this.clearChat();
          }
          
          // Escape to stop generation
          if (e.key === 'Escape' && this.isTyping) {
            e.preventDefault();
            this.stopGeneration();
          }
        });
      }

      handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (this.isTyping) {
            this.stopGeneration();
          } else {
            this.sendMessage();
          }
        }
        
        // Auto-expand textarea
        this.autoResizeTextarea(e.target);
      }

      handleInput(e) {
        this.autoResizeTextarea(e.target);
        this.updateCharCount();
        this.updateLastActivity();
      }

      handlePaste(e) {
        setTimeout(() => {
          this.autoResizeTextarea(e.target);
          this.updateCharCount();
        }, 0);
      }

      autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 250) + 'px';
      }

      updateCharCount() {
        const textarea = document.getElementById('chat-input');
        const charCount = document.getElementById('char-count');
        const count = textarea.value.length;
        charCount.textContent = count;
        
        if (count > 3500) {
          charCount.style.color = 'var(--danger-color)';
        } else if (count > 3000) {
          charCount.style.color = 'var(--warning-color)';
        } else {
          charCount.style.color = 'var(--text-muted)';
        }
      }

      updateLastActivity() {
        this.lastActivity = Date.now();
      }

      startActivityMonitoring() {
        setInterval(() => {
          const inactive = Date.now() - this.lastActivity;
          if (inactive > 300000) { // 5 minutes
            this.updateStatus('away', 'Away');
          } else if (inactive > 60000) { // 1 minute
            this.updateStatus('idle', 'Idle');
          }
        }, 30000);
      }

      updateStatus(type, text) {
        const statusEl = document.getElementById('chat-status');
        const textEl = document.getElementById('status-text');
        
        statusEl.className = 'chat-status status-' + type;
        textEl.textContent = text;
        statusEl.style.display = 'block';
        
        if (type === 'error') {
          setTimeout(() => {
            statusEl.style.display = 'none';
          }, 5000);
        }
      }

      async loadModelInfo() {
        try {
          const modelEl = document.getElementById('current-model');
          modelEl.textContent = 'Devstral AI';
          
          // You could fetch actual model info from API
          setTimeout(() => {
            modelEl.innerHTML = '<i class="bi bi-check-circle text-success"></i> Devstral AI';
          }, 1000);
        } catch (error) {
          console.warn('Could not load model info:', error);
        }
      }

      async loadChatHistory() {
        try {
          this.updateStatus('typing', 'Loading history...');
          
          const response = await fetch('/api/chat/history?limit=20', { 
            credentials: 'include' 
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.messages.length > 0) {
              // Hide welcome prompt
              document.getElementById('welcome-prompt').style.display = 'none';
              
              // Load messages
              data.messages.reverse().forEach(msg => {
                this.addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content, false);
              });
              
              this.messageCount = data.messages.length;
              DevstralCommon.trackEvent('history_loaded', data.messages.length.toString());
            }
          }
          
          this.updateStatus('online', 'Ready');
        } catch (error) {
          console.warn('Could not load history:', error);
          this.updateStatus('error', 'History load failed');
        }
      }

      async sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || this.isTyping || message.length > 4000) return;

        // Hide welcome prompt
        document.getElementById('welcome-prompt').style.display = 'none';
        
        this.addMessage('user', message);
        input.value = '';
        input.style.height = 'auto';
        this.updateCharCount();
        
        this.isTyping = true;
        this.updateButtons(true);
        this.updateStatus('typing', 'AI is thinking...');

        this.abortController = new AbortController();
        const aiMessage = this.addMessage('ai', '', true);
        let accumulated = '';

        try {
          const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            signal: this.abortController.signal,
            body: JSON.stringify({ 
              message: message, 
              include_history: true,
              options: {
                temperature: 0.7,
                max_tokens: 2048
              }
            })
          });

          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const jsonStr = line.slice(6);
                if (jsonStr === '[DONE]') {
                  this.finishStreaming(aiMessage, accumulated);
                  return;
                }

                try {
                  const data = JSON.parse(jsonStr);
                  if (data.content) {
                    accumulated += data.content;
                    this.updateStreamingMessage(aiMessage, accumulated);
                  }
                  if (data.error) {
                    throw new Error(data.error);
                  }
                } catch (parseError) {
                  // Ignore parse errors for partial JSON
                }
              }
            }
          }

          this.finishStreaming(aiMessage, accumulated);
        } catch (error) {
          if (error.name === 'AbortError') {
            this.finishStreaming(aiMessage, accumulated + '\n\n*Interrupted by user*');
          } else {
            console.error('Chat error:', error);
            this.updateStreamingMessage(aiMessage, '*Error: ' + error.message + '*');
            this.finishStreaming(aiMessage, '*Error occurred*');
            this.updateStatus('error', 'Error occurred');
          }
        }
      }

      addMessage(sender, content, isStreaming = false) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${sender}`;
        
        const avatar = document.createElement('i');
        avatar.className = `bi bi-${sender === 'user' ? 'person-circle' : 'robot'}`;
        avatar.style.fontSize = '24px';
        avatar.style.color = sender === 'user' ? 'var(--primary-color)' : 'var(--success-color)';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (isStreaming) {
          contentDiv.innerHTML = '<span class="streaming-content"></span>';
        } else {
          contentDiv.innerHTML = marked.parse(content);
        }
        
        // Add message actions for AI messages
        if (sender === 'ai' && !isStreaming) {
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'message-actions';
          actionsDiv.innerHTML = `
            <button class="action-btn" onclick="window.chat.copyMessage(this)" title="Copy">
              <i class="bi bi-clipboard"></i>
            </button>
            <button class="action-btn" onclick="window.chat.regenerateMessage(this)" title="Regenerate">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          `;
          contentDiv.appendChild(actionsDiv);
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        this.messageCount++;
        this.updateLastActivity();
        
        return messageDiv;
      }

      updateStreamingMessage(messageDiv, content) {
        const streamingEl = messageDiv.querySelector('.streaming-content');
        if (streamingEl) {
          streamingEl.innerHTML = marked.parse(content) + '<span class="cursor">â–‹</span>';
        }
      }

      finishStreaming(messageDiv, finalContent) {
        const streamingEl = messageDiv.querySelector('.streaming-content');
        if (streamingEl) {
          streamingEl.innerHTML = marked.parse(finalContent);
          
          // Add message actions
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'message-actions';
          actionsDiv.innerHTML = `
            <button class="action-btn" onclick="window.chat.copyMessage(this)" title="Copy">
              <i class="bi bi-clipboard"></i>
            </button>
            <button class="action-btn" onclick="window.chat.regenerateMessage(this)" title="Regenerate">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          `;
          messageDiv.querySelector('.message-content').appendChild(actionsDiv);
        }
        
        this.isTyping = false;
        this.updateButtons(false);
        this.updateStatus('online', 'Ready');
        
        // Track completion
        DevstralCommon.trackEvent('message_completed', this.messageCount.toString());
      }

      stopGeneration() {
        if (this.abortController) {
          this.abortController.abort();
        }
        this.updateStatus('online', 'Stopped');
      }

      updateButtons(isTyping) {
        document.getElementById('send-button').style.display = isTyping ? 'none' : 'flex';
        document.getElementById('stop-button').style.display = isTyping ? 'flex' : 'none';
        document.getElementById('chat-input').disabled = isTyping;
      }

      async clearChat() {
        if (!confirm('Are you sure you want to clear your chat history? This cannot be undone.')) {
          return;
        }

        try {
          this.updateStatus('typing', 'Clearing chat...');
          
          const response = await fetch('/api/chat/clear', {
            method: 'POST',
            credentials: 'include'
          });

          const data = await response.json();
          if (data.success) {
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('welcome-prompt').style.display = 'block';
            this.messageCount = 0;
            this.updateStatus('online', 'Chat cleared');
            
            DevstralCommon.trackEvent('chat_cleared', 'success');
          } else {
            throw new Error(data.error || 'Unknown error');
          }
        } catch (error) {
          console.error('Clear chat error:', error);
          this.updateStatus('error', 'Clear failed');
        }
      }

      copyMessage(button) {
        const messageContent = button.closest('.message-content');
        const text = messageContent.innerText.replace(/Copy\s*Regenerate\s*$/, '').trim();
        
        navigator.clipboard.writeText(text).then(() => {
          const icon = button.querySelector('i');
          icon.className = 'bi bi-check';
          setTimeout(() => {
            icon.className = 'bi bi-clipboard';
          }, 1000);
          
          DevstralCommon.trackEvent('message_copied', 'success');
        }).catch(err => {
          console.error('Copy failed:', err);
        });
      }

      regenerateMessage(button) {
        // Find the previous user message and resend it
        const aiMessage = button.closest('.message');
        const messages = Array.from(document.querySelectorAll('.message'));
        const aiIndex = messages.indexOf(aiMessage);
        
        if (aiIndex > 0) {
          const userMessage = messages[aiIndex - 1];
          if (userMessage.classList.contains('message-user')) {
            const userText = userMessage.querySelector('.message-content').innerText;
            
            // Remove the AI message
            aiMessage.remove();
            
            // Set input and send
            document.getElementById('chat-input').value = userText;
            this.sendMessage();
            
            DevstralCommon.trackEvent('message_regenerated', 'success');
          }
        }
      }

      handleWindowFocus() {
        this.updateLastActivity();
        if (!this.isTyping) {
          this.updateStatus('online', 'Ready');
        }
      }

      handleWindowBlur() {
        // Optional: Update status when window loses focus
      }

      handlePageUnload() {
        // Cleanup if needed
        if (this.abortController) {
          this.abortController.abort();
        }
      }
    }

    // Initialize chat when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      window.chat = new DevstralChat();
    });
  </script>
</body>
</html>