<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Devstral AI</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-robot"></i> Devstral AI
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="bi bi-house"></i> Home
                </a>
                <a class="nav-link" href="/login">
                    <i class="bi bi-box-arrow-in-right"></i> Login
                </a>
            </div>
        </div>
    </nav>

    <main class="container-fluid py-4">
        <!-- Flash messages container -->
        <div id="flash-messages"></div>
        
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card border-secondary">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-person-plus"></i> Register
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Registration status info -->
                        <div id="registration-info">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <form id="registerForm" style="display: none;">
                            <div class="mb-3">
                                <label for="username" class="form-label">
                                    <i class="bi bi-person"></i> Username
                                </label>
                                <input type="text" class="form-control" id="username" name="username" 
                                       placeholder="3-50 characters" required 
                                       minlength="3" maxlength="50"
                                       pattern="^[a-zA-Z0-9_-]+$">
                                <div class="form-text">3-50 characters, letters, numbers, underscore, and dash only</div>
                                <div class="invalid-feedback" id="username-feedback"></div>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">
                                    <i class="bi bi-lock"></i> Password
                                </label>
                                <input type="password" class="form-control" id="password" name="password" 
                                       placeholder="6-128 characters" required 
                                       minlength="6" maxlength="128">
                                <div class="form-text">6-128 characters</div>
                                <div class="invalid-feedback" id="password-feedback"></div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">
                                    <i class="bi bi-lock-fill"></i> Confirm Password
                                </label>
                                <input type="password" class="form-control" id="confirmPassword" 
                                       name="confirmPassword" required 
                                       minlength="6" maxlength="128">
                                <div class="invalid-feedback" id="confirm-password-feedback"></div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="register-btn">
                                    <i class="bi bi-person-plus"></i> Register (Pending Approval)
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-3 text-center">
                            <p>Already have an account? 
                                <a href="/login" class="text-primary">
                                    <i class="bi bi-box-arrow-in-right"></i> Login here
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/models.js"></script>
    <script src="/js/init.js"></script>
    <script src="/js/database.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/admin.js"></script>
    <script src="/js/chat.js"></script>
    <script src="/js/app.js"></script>
    
    <script>
        $(document).ready(function() {
            console.log('üìù Register page loaded');
            
            // Configuration
            const config = {
                MAX_PENDING_USERS: 2,
                MIN_USERNAME_LENGTH: 3,
                MAX_USERNAME_LENGTH: 50,
                MIN_PASSWORD_LENGTH: 6,
                MAX_PASSWORD_LENGTH: 128
            };
            
            // Initialize the app
            if (typeof DevstralApp !== 'undefined') {
                DevstralApp.init().then(async () => {
                    // Check if already authenticated
                    const currentUser = await DevstralApp.modules.auth.getCurrentUser();
                    if (currentUser) {
                        window.location.href = '/chat';
                        return;
                    }
                    
                    // Check registration status
                    await checkRegistrationStatus();
                    
                    console.log('‚úÖ Register app initialized');
                }).catch(error => {
                    console.error('‚ùå Register app initialization failed:', error);
                    Utils.showFlashMessage('Failed to initialize registration', 'error');
                });
            } else {
                console.error('‚ùå DevstralApp not found');
                Utils.showFlashMessage('Application not found', 'error');
            }
            
            async function checkRegistrationStatus() {
                try {
                    const pendingCount = await Database.getPendingUsersCount();
                    const registrationOpen = pendingCount < config.MAX_PENDING_USERS;
                    
                    if (registrationOpen) {
                        showRegistrationForm(pendingCount);
                    } else {
                        showRegistrationClosed(pendingCount);
                    }
                } catch (error) {
                    console.error('Error checking registration status:', error);
                    showRegistrationForm(0); // Default to open if check fails
                }
            }
            
            function showRegistrationForm(pendingCount) {
                $('#registration-info').html(`
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Registration requires admin approval.</strong><br>
                        After registering, please wait for an administrator to approve your account before you can log in.
                        
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-people"></i> 
                                Current pending registrations: ${pendingCount}/${config.MAX_PENDING_USERS}
                                ${pendingCount >= config.MAX_PENDING_USERS - 1 ? '<span class="text-warning">(Registration will close after this submission)</span>' : ''}
                            </small>
                        </div>
                    </div>
                `);
                
                $('#registerForm').show();
                setupFormValidation();
            }
            
            function showRegistrationClosed(pendingCount) {
                $('#registration-info').html(`
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Registration Temporarily Closed</strong><br>
                        We currently have the maximum number of pending registrations (${pendingCount}/${config.MAX_PENDING_USERS}). 
                        Please check back later when spots become available.
                    </div>
                `);
            }
            
            function setupFormValidation() {
                // Real-time validation
                $('#username').on('input', function() {
                    const username = $(this).val();
                    const validation = Utils.validateInput(username, 'username', { required: true });
                    
                    if (!validation.valid) {
                        $(this).addClass('is-invalid');
                        $('#username-feedback').text(validation.message);
                    } else {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    }
                });
                
                $('#password').on('input', function() {
                    const password = $(this).val();
                    const validation = Utils.validateInput(password, 'password', { required: true });
                    
                    if (!validation.valid) {
                        $(this).addClass('is-invalid');
                        $('#password-feedback').text(validation.message);
                    } else {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    }
                    
                    // Re-validate confirm password if it has a value
                    const confirmPassword = $('#confirmPassword').val();
                    if (confirmPassword) {
                        $('#confirmPassword').trigger('input');
                    }
                });
                
                $('#confirmPassword').on('input', function() {
                    const password = $('#password').val();
                    const confirmPassword = $(this).val();
                    
                    if (confirmPassword && password !== confirmPassword) {
                        $(this).addClass('is-invalid');
                        $('#confirm-password-feedback').text('Passwords do not match');
                    } else if (confirmPassword) {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $(this).removeClass('is-invalid is-valid');
                    }
                });
                
                // Form submission
                $('#registerForm').on('submit', function(e) {
                    e.preventDefault();
                    handleRegistration();
                });
            }
            
            async function handleRegistration() {
                const username = $('#username').val().trim();
                const password = $('#password').val();
                const confirmPassword = $('#confirmPassword').val();
                
                // Validate all fields
                const usernameValidation = Utils.validateInput(username, 'username', { required: true });
                const passwordValidation = Utils.validateInput(password, 'password', { required: true });
                
                if (!usernameValidation.valid) {
                    Utils.showFlashMessage(usernameValidation.message, 'error');
                    return;
                }
                
                if (!passwordValidation.valid) {
                    Utils.showFlashMessage(passwordValidation.message, 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    Utils.showFlashMessage('Passwords do not match', 'error');
                    return;
                }
                
                // Check if registration is still open
                try {
                    const pendingCount = await Database.getPendingUsersCount();
                    if (pendingCount >= config.MAX_PENDING_USERS) {
                        Utils.showFlashMessage('Registration is now closed. Too many pending approvals.', 'error');
                        await checkRegistrationStatus();
                        return;
                    }
                } catch (error) {
                    console.error('Error checking pending users:', error);
                }
                
                // Disable form
                Utils.showLoadingSpinner('#register-btn', 'Registering...');
                
                try {
                    // Check if username already exists
                    const existingUser = await Database.getUserByUsername(username);
                    if (existingUser) {
                        Utils.showFlashMessage('Username already exists', 'error');
                        return;
                    }
                    
                    // Hash password
                    const passwordHash = await AppInit.hashPassword(password);
                    
                    // Create new user
                    const newUser = new User(
                        null, // ID will be auto-generated
                        username,
                        passwordHash,
                        false, // is_admin
                        false  // is_approved (requires admin approval)
                    );
                    
                    await Database.saveUser(newUser);
                    
                    // Success!
                    Utils.showFlashMessage('Registration successful! Your account is pending admin approval. You will be notified when activated.', 'success');
                    
                    // Clear form
                    $('#registerForm')[0].reset();
                    $('.is-valid, .is-invalid').removeClass('is-valid is-invalid');
                    
                    // Update registration status
                    setTimeout(checkRegistrationStatus, 1000);
                    
                } catch (error) {
                    console.error('Registration error:', error);
                    Utils.showFlashMessage('Registration failed: ' + error.message, 'error');
                } finally {
                    Utils.hideLoadingSpinner('#register-btn');
                }
            }
        });
                
        
        // Validate all fields
        const usernameValidation = Utils.validateInput(username, 'username', { required: true });
        const passwordValidation = Utils.validateInput(password, 'password', { required: true });
        
        if (!usernameValidation.valid) {
            Utils.showFlashMessage(usernameValidation.message, 'error');
            return;
        }
        
        if (!passwordValidation.valid) {
            Utils.showFlashMessage(passwordValidation.message, 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            Utils.showFlashMessage('Passwords do not match', 'error');
            return;
        }
        
        // Check if registration is still open
        try {
            const pendingCount = await Database.getPendingUsersCount();
            if (pendingCount >= config.MAX_PENDING_USERS) {
                Utils.showFlashMessage('Registration is now closed. Too many pending approvals.', 'error');
                await checkRegistrationStatus();
                return;
            }
        } catch (error) {
            console.error('Error checking pending users:', error);
        }
        
        // Disable form
        Utils.showLoadingSpinner('#register-btn', 'Registering...');
        
        try {
            // Check if username already exists
            const existingUser = await Database.getUserByUsername(username);
            if (existingUser) {
                Utils.showFlashMessage('Username already exists', 'error');
                return;
            }
            
            // Hash password
            const passwordHash = await AppInit.hashPassword(password);
            
            // Create new user
            const newUser = new User(
                null, // ID will be auto-generated
                username,
                passwordHash,
                false, // is_admin
                false  // is_approved (requires admin approval)
            );
            
            await Database.saveUser(newUser);
            
            // Success!
            Utils.showFlashMessage('Registration successful! Your account is pending admin approval. You will be notified when activated.', 'success');
            
            // Clear form
            $('#registerForm')[0].reset();
            $('.is-valid, .is-invalid').removeClass('is-valid is-invalid');
            
            // Update registration status
            setTimeout(checkRegistrationStatus, 1000);
            
        } catch (error) {
            console.error('Registration error:', error);
            Utils.showFlashMessage('Registration failed: ' + error.message, 'error');
        } finally {
            Utils.hideLoadingSpinner('#register-btn');
        }

    </script>
</body>
</html>